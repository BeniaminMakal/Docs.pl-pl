---
uid: web-api/overview/security/authentication-filters
title: "Filtry uwierzytelniania w składniku ASP.NET Web API 2 | Dokumentacja firmy Microsoft"
author: MikeWasson
description: "Filtr uwierzytelniania jest składnikiem, który uwierzytelnia żądanie HTTP. Interfejs API sieci Web 2 i MVC 5 obsługuje zarówno filtry uwierzytelniania, ale różnią się nieco..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: eee4e7accd338262698d127ed08d4182608839ab
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 11/10/2017
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="775d8-104">Filtry uwierzytelniania w składniku ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="775d8-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="775d8-105">przez [Wasson Jan](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="775d8-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="775d8-106">Filtr uwierzytelniania jest składnikiem, który uwierzytelnia żądanie HTTP.</span><span class="sxs-lookup"><span data-stu-id="775d8-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="775d8-107">Interfejs API sieci Web 2 i MVC 5 obsługuje zarówno filtry uwierzytelniania, ale różnią się nieznacznie, przede wszystkim konwencje nazewnictwa dla interfejsu filtru.</span><span class="sxs-lookup"><span data-stu-id="775d8-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="775d8-108">W tym temacie opisano filtry uwierzytelniania interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="775d8-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="775d8-109">Filtry uwierzytelniania pozwalają na ustawienie schematu uwierzytelniania do poszczególnych kontrolerów lub akcji.</span><span class="sxs-lookup"><span data-stu-id="775d8-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="775d8-110">W ten sposób aplikacja może obsługiwać różnych mechanizmów uwierzytelniania dla różnych zasobów HTTP.</span><span class="sxs-lookup"><span data-stu-id="775d8-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="775d8-111">W tym artykule opisano I kod z [uwierzytelnianie podstawowe](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) w [http://aspnet.codeplex.com](http://aspnet.codeplex.com). Przykład obejmuje filtr uwierzytelniania, który implementuje schemat uwierzytelniania dostępu do podstawowego HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="775d8-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com). The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="775d8-112">Filtr jest zaimplementowana w klasie o nazwie `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="775d8-112">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="775d8-113">I nie będzie zawierać cały kod z próbki, tylko części ilustrujące jak napisać filtr uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="775d8-113">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="775d8-114">Ustawienie filtru uwierzytelniania</span><span class="sxs-lookup"><span data-stu-id="775d8-114">Setting an Authentication Filter</span></span>

<span data-ttu-id="775d8-115">Podobnie jak inne filtry filtry uwierzytelniania może być zastosowane na kontrolerze, -action lub globalnie do wszystkich kontrolerów składnika Web API.</span><span class="sxs-lookup"><span data-stu-id="775d8-115">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="775d8-116">Aby zastosować filtr uwierzytelniania kontrolera, dekoracji klasy kontrolera przy użyciu atrybutu filtru.</span><span class="sxs-lookup"><span data-stu-id="775d8-116">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="775d8-117">Poniższy kod ustawia `[IdentityBasicAuthentication]` Filtr klasy kontrolera, który umożliwia uwierzytelnianie podstawowe dla wszystkich akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="775d8-117">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="775d8-118">Aby zastosować filtr do jednej akcji, dekoracji akcji z filtrem.</span><span class="sxs-lookup"><span data-stu-id="775d8-118">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="775d8-119">Poniższy kod ustawia `[IdentityBasicAuthentication]` filtru na kontrolerze `Post` metody.</span><span class="sxs-lookup"><span data-stu-id="775d8-119">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="775d8-120">Aby zastosować filtr do wszystkich kontrolerów interfejsu API sieci Web, dodaj go do **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="775d8-120">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="775d8-121">Implementacja filtru uwierzytelniania interfejsu API sieci Web</span><span class="sxs-lookup"><span data-stu-id="775d8-121">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="775d8-122">W składniku Web API implementuje filtry uwierzytelniania [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/en-us/library/system.web.http.filters.iauthenticationfilter.aspx) interfejsu.</span><span class="sxs-lookup"><span data-stu-id="775d8-122">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/en-us/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="775d8-123">Powinny one również dziedziczyć **System.Attribute**, aby można zastosować jako atrybuty.</span><span class="sxs-lookup"><span data-stu-id="775d8-123">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="775d8-124">**IAuthenticationFilter** interfejs ma dwóch metod:</span><span class="sxs-lookup"><span data-stu-id="775d8-124">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="775d8-125">**Metody AuthenticateAsync** uwierzytelnia żądanie przez sprawdzanie poprawności poświadczeń w żądaniu, jeśli jest obecny.</span><span class="sxs-lookup"><span data-stu-id="775d8-125">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="775d8-126">**ChallengeAsync** dodaje żądanie uwierzytelniania do odpowiedzi HTTP, jeśli to konieczne.</span><span class="sxs-lookup"><span data-stu-id="775d8-126">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="775d8-127">Te metody odpowiadają przepływ uwierzytelniania zdefiniowane w [RFC 2612](http://tools.ietf.org/html/rfc2616) i [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="775d8-127">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="775d8-128">Klient wysyła poświadczenia w nagłówku autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="775d8-128">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="775d8-129">Dzieje się tak zazwyczaj po odebraniu odpowiedzi 401 (nieautoryzowane) z serwera.</span><span class="sxs-lookup"><span data-stu-id="775d8-129">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="775d8-130">Jednak klient może wysyłać poświadczenia z żadnym żądaniem nie tylko po pierwsze 401.</span><span class="sxs-lookup"><span data-stu-id="775d8-130">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="775d8-131">Jeśli serwer nie akceptuje poświadczeń, zwraca odpowiedzi 401 (nieautoryzowanych).</span><span class="sxs-lookup"><span data-stu-id="775d8-131">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="775d8-132">Odpowiedź zawiera nagłówek Www-Authenticate, który zawiera co najmniej jeden wyzwania.</span><span class="sxs-lookup"><span data-stu-id="775d8-132">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="775d8-133">Każdego żądania Określa schemat uwierzytelniania rozpoznany przez serwer.</span><span class="sxs-lookup"><span data-stu-id="775d8-133">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="775d8-134">Serwer można również zwrócić 401 na podstawie żądania od użytkowników anonimowych.</span><span class="sxs-lookup"><span data-stu-id="775d8-134">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="775d8-135">W rzeczywistości, który jest zwykle jak proces uwierzytelniania jest inicjowany:</span><span class="sxs-lookup"><span data-stu-id="775d8-135">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="775d8-136">Klient wysyła żądania od użytkowników anonimowych.</span><span class="sxs-lookup"><span data-stu-id="775d8-136">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="775d8-137">Serwer zwraca 401.</span><span class="sxs-lookup"><span data-stu-id="775d8-137">The server returns 401.</span></span>
3. <span data-ttu-id="775d8-138">Wysyła żądanie przy użyciu poświadczeń ponownie klientów.</span><span class="sxs-lookup"><span data-stu-id="775d8-138">The clients resends the request with credentials.</span></span>

<span data-ttu-id="775d8-139">Obejmuje to przepływ *uwierzytelniania* i *autoryzacji* czynności.</span><span class="sxs-lookup"><span data-stu-id="775d8-139">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="775d8-140">Uwierzytelnianie potwierdza tożsamość klienta.</span><span class="sxs-lookup"><span data-stu-id="775d8-140">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="775d8-141">Autoryzacji określa, czy klient może uzyskiwać dostęp do określonego zasobu.</span><span class="sxs-lookup"><span data-stu-id="775d8-141">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="775d8-142">W składniku Web API filtry uwierzytelniania obsługi uwierzytelniania, ale nie autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="775d8-142">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="775d8-143">Autoryzacji powinno być wykonywane przez filtr autoryzacji lub wewnątrz akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="775d8-143">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="775d8-144">Poniżej przedstawiono przepływ w potoku 2 interfejsu API sieci Web:</span><span class="sxs-lookup"><span data-stu-id="775d8-144">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="775d8-145">Przed wywołaniem akcji, interfejsu API sieci Web tworzy listę filtrów uwierzytelniania dla tej akcji.</span><span class="sxs-lookup"><span data-stu-id="775d8-145">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="775d8-146">W tym filtrów z zakresu działania, kontrolera zakres i zasięg globalny.</span><span class="sxs-lookup"><span data-stu-id="775d8-146">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="775d8-147">Sieci Web interfejsu API **metody AuthenticateAsync** dla każdego filtru na liście.</span><span class="sxs-lookup"><span data-stu-id="775d8-147">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="775d8-148">Każdy filtr można zweryfikować poświadczeń w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="775d8-148">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="775d8-149">Jeśli dowolny filtr, który pomyślnie sprawdza poprawność poświadczeń, tworzy filtr **IPrincipal** i dołącza je do żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-149">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="775d8-150">W tym momencie filtru może także wyzwolić wystąpił błąd.</span><span class="sxs-lookup"><span data-stu-id="775d8-150">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="775d8-151">Jeśli tak, pozostałego potoku nie działa.</span><span class="sxs-lookup"><span data-stu-id="775d8-151">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="775d8-152">Zakładając, że nie było błędu, żądanie przechodzi przez pozostałego potoku.</span><span class="sxs-lookup"><span data-stu-id="775d8-152">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="775d8-153">Ponadto interfejs API sieci Web wywołuje co filtr uwierzytelniania **ChallengeAsync** metody.</span><span class="sxs-lookup"><span data-stu-id="775d8-153">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="775d8-154">Filtry można dodać żądanie do odpowiedzi, użyj tej metody, w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="775d8-154">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="775d8-155">Zazwyczaj (ale nie zawsze) które mogłyby wystąpić w odpowiedzi na 401 błąd.</span><span class="sxs-lookup"><span data-stu-id="775d8-155">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="775d8-156">Na poniższych diagramach przedstawiono dwa możliwe przypadki.</span><span class="sxs-lookup"><span data-stu-id="775d8-156">The following diagrams show two possible cases.</span></span> <span data-ttu-id="775d8-157">W pierwszym filtr uwierzytelniania pomyślnie uwierzytelnia żądanie, filtr autoryzacji autoryzuje żądanie, i akcji kontrolera zwraca 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="775d8-157">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="775d8-158">W drugim przykładzie filtr uwierzytelniania uwierzytelnia żądanie, ale filtr autoryzacji zwraca 401 (bez autoryzacji).</span><span class="sxs-lookup"><span data-stu-id="775d8-158">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="775d8-159">W takim przypadku nie jest wywoływany akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="775d8-159">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="775d8-160">Filtr uwierzytelniania dodaje do odpowiedzi nagłówek Www-Authenticate.</span><span class="sxs-lookup"><span data-stu-id="775d8-160">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="775d8-161">Możliwe są inne kombinacje&mdash;na przykład, jeśli akcja kontrolera zezwala na anonimowe żądania, może być filtr uwierzytelniania, ale brak autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="775d8-161">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="775d8-162">Implementacja metody AuthenticateAsync — metoda</span><span class="sxs-lookup"><span data-stu-id="775d8-162">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="775d8-163">**Metody AuthenticateAsync** metody spróbuje się uwierzytelnić żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-163">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="775d8-164">Podpis metody jest następujący:</span><span class="sxs-lookup"><span data-stu-id="775d8-164">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="775d8-165">**Metody AuthenticateAsync** metody należy wykonać jedną z następujących czynności:</span><span class="sxs-lookup"><span data-stu-id="775d8-165">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="775d8-166">Brak elementów (pusta).</span><span class="sxs-lookup"><span data-stu-id="775d8-166">Nothing (no-op).</span></span>
2. <span data-ttu-id="775d8-167">Utwórz **IPrincipal** i ustaw ją na żądanie.</span><span class="sxs-lookup"><span data-stu-id="775d8-167">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="775d8-168">Ustaw wynik błędu.</span><span class="sxs-lookup"><span data-stu-id="775d8-168">Set an error result.</span></span>

<span data-ttu-id="775d8-169">Opcja (1) oznacza, że żądanie nie miał wszystkie poświadczenia, które rozumie filtru.</span><span class="sxs-lookup"><span data-stu-id="775d8-169">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="775d8-170">Opcja (2) oznacza, że filtr pomyślnie uwierzytelnić żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-170">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="775d8-171">Opcja (3) oznacza, że żądanie było nieprawidłowe poświadczenia (na przykład nieprawidłowe hasło), wyzwalające odpowiedzi na błąd.</span><span class="sxs-lookup"><span data-stu-id="775d8-171">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="775d8-172">Oto ogólny zarys wykonywania **metody AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="775d8-172">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="775d8-173">Poszukaj poświadczeń w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="775d8-173">Look for credentials in the request.</span></span>
2. <span data-ttu-id="775d8-174">Jeśli nie ma żadnych poświadczeń, nic nie rób i zwracać (pusta).</span><span class="sxs-lookup"><span data-stu-id="775d8-174">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="775d8-175">Jeśli istnieją poświadczeń, ale filtr nie może rozpoznać schematu uwierzytelniania, nic nie rób i zwracać (pusta).</span><span class="sxs-lookup"><span data-stu-id="775d8-175">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="775d8-176">Inny filtr w potoku może zrozumieć schemat.</span><span class="sxs-lookup"><span data-stu-id="775d8-176">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="775d8-177">W przypadku poświadczenia, które obsługuje usługę filtr, spróbuj je uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="775d8-177">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="775d8-178">Jeśli poświadczenia są nieprawidłowe, zwróć 401 przez ustawienie `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="775d8-178">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="775d8-179">Jeśli poświadczenia są prawidłowe, Utwórz **IPrincipal** i ustaw `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="775d8-179">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="775d8-180">W kodzie wykonaj **metody AuthenticateAsync** metody z [uwierzytelnianie podstawowe](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) próbki.</span><span class="sxs-lookup"><span data-stu-id="775d8-180">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="775d8-181">Komentarze wskazują każdego kroku.</span><span class="sxs-lookup"><span data-stu-id="775d8-181">The comments indicate each step.</span></span> <span data-ttu-id="775d8-182">Ten kod zawiera błąd kilka typów: Nagłówek uwierzytelnienia bez poświadczeń, poświadczenia źle sformułowane i zły nazwy użytkownika i hasła.</span><span class="sxs-lookup"><span data-stu-id="775d8-182">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="775d8-183">Ustawienie wynik błędu</span><span class="sxs-lookup"><span data-stu-id="775d8-183">Setting an Error Result</span></span>

<span data-ttu-id="775d8-184">Jeśli poświadczenia są nieprawidłowe, należy ustawić filtr `context.ErrorResult` do **IHttpActionResult** tworzącą odpowiedzi na błąd.</span><span class="sxs-lookup"><span data-stu-id="775d8-184">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="775d8-185">Aby uzyskać więcej informacji na temat **IHttpActionResult**, zobacz [wyniki akcji w sieci Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="775d8-185">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="775d8-186">Zawiera przykładowe uwierzytelnianie podstawowe `AuthenticationFailureResult` klasy, które jest odpowiednie dla tego celu.</span><span class="sxs-lookup"><span data-stu-id="775d8-186">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="775d8-187">Implementowanie ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="775d8-187">Implementing ChallengeAsync</span></span>

<span data-ttu-id="775d8-188">Celem **ChallengeAsync** metody jest dodanie wezwań do uwierzytelnienia do odpowiedzi, w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="775d8-188">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="775d8-189">Podpis metody jest następujący:</span><span class="sxs-lookup"><span data-stu-id="775d8-189">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="775d8-190">Metoda jest wywoływana w filtrze uwierzytelniania, co w potoku żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-190">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="775d8-191">Należy pamiętać, że **ChallengeAsync** jest nazywany *przed* odpowiedź HTTP został utworzony i być może nawet przed uruchomieniem akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="775d8-191">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="775d8-192">Gdy **ChallengeAsync** jest nazywany `context.Result` zawiera **IHttpActionResult**, później używany do tworzenia odpowiedzi HTTP.</span><span class="sxs-lookup"><span data-stu-id="775d8-192">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="775d8-193">W takim przypadku **ChallengeAsync** jest wywoływana, nie wiesz nic o odpowiedzi HTTP jeszcze.</span><span class="sxs-lookup"><span data-stu-id="775d8-193">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="775d8-194">**ChallengeAsync** metody należy zastąpić oryginalnej wartości elementu `context.Result` o nowe **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="775d8-194">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="775d8-195">To **IHttpActionResult** musi zawijać oryginalnej `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="775d8-195">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="775d8-196">Będzie można wywołać oryginalnej **IHttpActionResult** *wewnętrzny wynik*i nowych **IHttpActionResult** *zewnętrzne wynik*.</span><span class="sxs-lookup"><span data-stu-id="775d8-196">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="775d8-197">Wynik zewnętrzne, wykonaj następujące czynności:</span><span class="sxs-lookup"><span data-stu-id="775d8-197">The outer result must do the following:</span></span>

1. <span data-ttu-id="775d8-198">Wywołania wewnętrznego wynik do tworzenia odpowiedzi HTTP.</span><span class="sxs-lookup"><span data-stu-id="775d8-198">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="775d8-199">Sprawdź, czy odpowiedź.</span><span class="sxs-lookup"><span data-stu-id="775d8-199">Examine the response.</span></span>
3. <span data-ttu-id="775d8-200">W razie potrzeby należy dodać żądania uwierzytelnienia na potrzeby odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="775d8-200">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="775d8-201">Poniższy przykład pochodzi z przykładowej uwierzytelnianie podstawowe.</span><span class="sxs-lookup"><span data-stu-id="775d8-201">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="775d8-202">Definiuje **IHttpActionResult** dla wyniku zewnętrzne.</span><span class="sxs-lookup"><span data-stu-id="775d8-202">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="775d8-203">`InnerResult` Właściwość przechowuje wewnętrzny **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="775d8-203">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="775d8-204">`Challenge` Właściwość reprezentuje nagłówek Www-uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="775d8-204">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="775d8-205">Zwróć uwagę, że **ExecuteAsync** najpierw wywołuje `InnerResult.ExecuteAsync` do tworzenia odpowiedzi HTTP, a następnie dodaje żądania, jeśli to konieczne.</span><span class="sxs-lookup"><span data-stu-id="775d8-205">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="775d8-206">Sprawdzenia kodu odpowiedzi przed dodaniem żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-206">Check the response code before adding the challenge.</span></span> <span data-ttu-id="775d8-207">Większość schematy uwierzytelniania tylko dodać żądanie w przypadku odpowiedzi 401, jak pokazano poniżej.</span><span class="sxs-lookup"><span data-stu-id="775d8-207">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="775d8-208">Jednak niektóre schematy uwierzytelniania Dodaj żądanie do odpowiedź sukcesu.</span><span class="sxs-lookup"><span data-stu-id="775d8-208">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="775d8-209">Na przykład, zobacz [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="775d8-209">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="775d8-210">Podane `AddChallengeOnUnauthorizedResult` rzeczywisty kod w klasie **ChallengeAsync** jest proste.</span><span class="sxs-lookup"><span data-stu-id="775d8-210">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="775d8-211">Po prostu utworzyć wynik i dołącz je do `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="775d8-211">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="775d8-212">Uwaga: Przykład uwierzytelnianie podstawowe abstracts tę logikę nieco, umieszczając je w metodzie rozszerzenia.</span><span class="sxs-lookup"><span data-stu-id="775d8-212">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="775d8-213">Łączenie filtry uwierzytelniania z uwierzytelnianiem na poziomie hosta</span><span class="sxs-lookup"><span data-stu-id="775d8-213">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="775d8-214">"Uwierzytelnianie na poziomie hosta" jest uwierzytelnianie przeprowadzane przez hosta (np. usługi IIS), przed framework osiągnie interfejsu API sieci Web żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-214">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="775d8-215">Często możesz włączyć uwierzytelnianie na poziomie hosta w pozostałej części aplikacji, jednak ją wyłączyć dla kontrolerów interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="775d8-215">Often, you may want to to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="775d8-216">Na przykład typowy scenariusz jest, aby włączyć uwierzytelnianie formularzy na poziomie hosta, ale używa uwierzytelniania opartego na tokenach do interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="775d8-216">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="775d8-217">Aby wyłączyć uwierzytelnianie na poziomie hosta wewnątrz potok składnika Web API, należy wywołać `config.SuppressHostPrincipal()` w konfiguracji.</span><span class="sxs-lookup"><span data-stu-id="775d8-217">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="775d8-218">Powoduje to interfejs API sieci Web usunąć **IPrincipal** z żadnym żądaniem wprowadzanych potok składnika Web API.</span><span class="sxs-lookup"><span data-stu-id="775d8-218">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="775d8-219">W rezultacie jego &quot;un-uwierzytelnia&quot; żądania.</span><span class="sxs-lookup"><span data-stu-id="775d8-219">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="775d8-220">Dodatkowe zasoby</span><span class="sxs-lookup"><span data-stu-id="775d8-220">Additional Resources</span></span>

<span data-ttu-id="775d8-221">[Filtry zabezpieczeń interfejsu API sieci Web ASP.NET](https://msdn.microsoft.com/en-us/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="775d8-221">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/en-us/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
