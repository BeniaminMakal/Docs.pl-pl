---
title: "Zarządzanie kluczami"
author: rick-anderson
description: "W tym dokumencie przedstawiono szczegóły implementacji platformy ASP.NET Core danych ochrony zarządzanie kluczami interfejsów API."
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 53adb067751917a9539a310bb7d91e599696f213
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 01/19/2018
---
# <a name="key-management"></a><span data-ttu-id="806e6-103">Zarządzanie kluczami</span><span class="sxs-lookup"><span data-stu-id="806e6-103">Key Management</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="806e6-104">System ochrony danych automatycznie zarządza czasem istnienia kluczy głównych używany do zabezpieczania i odbezpieczania ładunków.</span><span class="sxs-lookup"><span data-stu-id="806e6-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="806e6-105">Każdy klucz może istnieć w jednym z czterech etapów:</span><span class="sxs-lookup"><span data-stu-id="806e6-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="806e6-106">Utworzone — klucz istnieje w kręgu klucza, ale nie zostało jeszcze uaktywnione.</span><span class="sxs-lookup"><span data-stu-id="806e6-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="806e6-107">Klucz nie powinien służyć do nowych operacji Chroń przed upływem wystarczającą ilość czasu czy klucz miał możliwość obejmie wszystkie maszyny korzystające pierścień tego klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="806e6-108">Aktywny - klucz istnieje w kręgu klucza i należy jej używać do wszystkich nowych operacji Chroń.</span><span class="sxs-lookup"><span data-stu-id="806e6-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="806e6-109">Ważność — klucz jest wykonywane jego fizyczną okres istnienia i już używanego dla nowych operacji Chroń.</span><span class="sxs-lookup"><span data-stu-id="806e6-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="806e6-110">Odwołany — klucz zostanie naruszony i nie mogą być używane dla nowej operacji Chroń.</span><span class="sxs-lookup"><span data-stu-id="806e6-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="806e6-111">Utworzony, aktywne i wygasłe klucze mogą używane do usunięcia ochrony ładunków przychodzących.</span><span class="sxs-lookup"><span data-stu-id="806e6-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="806e6-112">Odwołania kluczy domyślnie nie można używać do usunięcia ochrony ładunków, ale Deweloper aplikacji może [zastąpienia tego zachowania](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="806e6-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="806e6-113">Deweloper może być wydawać się usuwanie klucza z pierścienia klucz (np. przez usunięcie odpowiedniego pliku z systemu plików).</span><span class="sxs-lookup"><span data-stu-id="806e6-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="806e6-114">W tym momencie wszystkie dane chronione za pomocą klucza jest trwale niemożliwe do odczytania, a nie zastąpień awaryjnego, tak jak w przypadku kluczy odwołane.</span><span class="sxs-lookup"><span data-stu-id="806e6-114">At that point, all data protected by the key is permanently undecipherable, and there is no emergency override like there is with revoked keys.</span></span> <span data-ttu-id="806e6-115">Usuwanie klucza jest rzeczywiście destrukcyjnego zachowanie, i w związku z tym system ochrony danych udostępnia żadnego pierwszej klasy interfejsu API do wykonania tej operacji.</span><span class="sxs-lookup"><span data-stu-id="806e6-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="806e6-116">Domyślny wybór klucza</span><span class="sxs-lookup"><span data-stu-id="806e6-116">Default key selection</span></span>

<span data-ttu-id="806e6-117">Gdy system ochrony danych odczytuje pierścień klucza z repozytorium zapasowy, spróbuje zlokalizować "domyślny" klucz z pierścienia klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="806e6-118">Domyślny klucz służy do nowych operacji Chroń.</span><span class="sxs-lookup"><span data-stu-id="806e6-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="806e6-119">Ogólne heurystyki jest wybierze klucz przy użyciu najnowszych danych aktywacji jako domyślny klucz w systemu ochrony danych.</span><span class="sxs-lookup"><span data-stu-id="806e6-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="806e6-120">(Brak współczynnik małych fudge umożliwiające zegar serwera serwera pochylenia.) Jeśli klucz jest wygasłe lub odwołane, i jeśli aplikacja nie została wyłączona automatycznego generowania klucza, a następnie zostanie wygenerowany nowy klucz o natychmiastowej aktywacji na [kluczy wygaśnięcia i stopniowych](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) zasad poniżej.</span><span class="sxs-lookup"><span data-stu-id="806e6-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="806e6-121">Przyczyna systemu ochrony danych natychmiast generuje nowy klucz, a nie nastąpi powrót do innego klucza jest, że wygenerowanie nowego klucza powinien być traktowany jako niejawne ważności wszystkich kluczy, które zostały aktywowane przed nowego klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="806e6-122">Ogólne informacje o tym jest nowe klucze zostały skonfigurowane z różnych algorytmów lub mechanizmów szyfrowania w rest niż stare klucze, czy system powinien Preferuj bieżącej konfiguracji przed powrotem.</span><span class="sxs-lookup"><span data-stu-id="806e6-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="806e6-123">Brak Wystąpił wyjątek.</span><span class="sxs-lookup"><span data-stu-id="806e6-123">There is an exception.</span></span> <span data-ttu-id="806e6-124">Jeśli Deweloper aplikacji ma [wyłączona, automatyczne generowanie klucza](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), a następnie systemu ochrony danych należy wybrać element jako domyślny klucz.</span><span class="sxs-lookup"><span data-stu-id="806e6-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="806e6-125">W tym scenariuszu rezerwowy systemu wybierze klucza odwołane przy użyciu najnowszych danych aktywacji, z preferencją klucze, których czas na propagację do innych komputerów w klastrze.</span><span class="sxs-lookup"><span data-stu-id="806e6-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="806e6-126">System rezerwowy może zakończyć się w związku z tym wybór domyślny wygasły klucz.</span><span class="sxs-lookup"><span data-stu-id="806e6-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="806e6-127">System rezerwowy nigdy nie wybierze klucz odwołane jako domyślny klucz, a pierścień klucza jest pusta lub został odwołany każdego klucza następnie systemu powoduje wygenerowanie wystąpił błąd podczas inicjowania.</span><span class="sxs-lookup"><span data-stu-id="806e6-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="806e6-128">Wygaśnięcie klucza i wdrażania</span><span class="sxs-lookup"><span data-stu-id="806e6-128">Key expiration and rolling</span></span>

<span data-ttu-id="806e6-129">Po utworzeniu klucza automatycznie znajduje się data aktywacji {teraz + 2 dni} i {teraz + 90 dni} daty wygaśnięcia.</span><span class="sxs-lookup"><span data-stu-id="806e6-129">When a key is created, it is automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="806e6-130">2-dniowego opóźnienie aktywacji daje klucza czas na propagację za pośrednictwem systemu.</span><span class="sxs-lookup"><span data-stu-id="806e6-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="806e6-131">Oznacza to umożliwia innym aplikacjom wskazując magazynu zapasowego przestrzegać klucz ich następnego okresu automatycznego odświeżania, w związku z tym maksymalizacja prawdopodobieństwo, że po klucz pierścienia ma stają się aktywne, którą ma on propagowane do wszystkich aplikacji, które może być konieczne jej używać.</span><span class="sxs-lookup"><span data-stu-id="806e6-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="806e6-132">Domyślny klucz wygaśnie w ciągu 2 dni i pierścień klucza nie ma już klucz, który będzie aktywny po wygaśnięciu domyślny klucz, w systemu ochrony danych będą automatycznie utrwalić nowy klucz do pierścień klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-132">If the default key will expire within 2 days and if the key ring does not already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="806e6-133">Ten nowy klucz ma Data aktywacji {Data wygaśnięcia domyślny klucz} i {teraz + 90 dni} daty wygaśnięcia.</span><span class="sxs-lookup"><span data-stu-id="806e6-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="806e6-134">Dzięki temu system automatycznie wycofanie kluczy na bieżąco z przerwy w świadczeniu usług.</span><span class="sxs-lookup"><span data-stu-id="806e6-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="806e6-135">Mogą wystąpić okoliczności gdzie klucz zostanie utworzony z natychmiastowej aktywacji.</span><span class="sxs-lookup"><span data-stu-id="806e6-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="806e6-136">Przykładem może dochodzić do aplikacji nie zostało uruchomione przez czas i wygasły wszystkie klucze w kręgu klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="806e6-137">W takim przypadku klucz znajduje się data aktywacji {teraz} niezwłocznie normalne 2-dniowego aktywacji.</span><span class="sxs-lookup"><span data-stu-id="806e6-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="806e6-138">Domyślny okres istnienia klucza jest 90 dni, ale można skonfigurować, jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="806e6-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="806e6-139">Administrator może zmienić również domyślny całego systemu, chociaż jawnym wywołaniem `SetDefaultKeyLifetime` spowoduje zastąpienie wszelkich zasady systemowe.</span><span class="sxs-lookup"><span data-stu-id="806e6-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="806e6-140">Domyślny okres istnienia klucza nie może być krótszy niż 7 dni.</span><span class="sxs-lookup"><span data-stu-id="806e6-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="806e6-141">Pierścień klucz automatycznego odświeżania</span><span class="sxs-lookup"><span data-stu-id="806e6-141">Automatic key ring refresh</span></span>

<span data-ttu-id="806e6-142">Gdy system ochrony danych, odczytuje pierścień klucz podstawowy repozytorium i buforuje ją w pamięci.</span><span class="sxs-lookup"><span data-stu-id="806e6-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="806e6-143">Ta pamięć podręczna umożliwia operacji Chroń i Unprotect kontynuować bez naciśnięcie magazynu zapasowego.</span><span class="sxs-lookup"><span data-stu-id="806e6-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="806e6-144">System automatycznie sprawdza magazynu zapasowego zmiany mniej więcej co 24 godziny lub po wygaśnięciu bieżący domyślny klucz zależności zostanie osiągnięty jako pierwszy.</span><span class="sxs-lookup"><span data-stu-id="806e6-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="806e6-145">Deweloperzy powinien bardzo rzadko (Jeśli kiedykolwiek) trzeba korzystać bezpośrednio zarządzania kluczami interfejsów API.</span><span class="sxs-lookup"><span data-stu-id="806e6-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="806e6-146">Automatyczne zarządzanie kluczami będzie wykonywać systemu ochrony danych, zgodnie z powyższym opisem.</span><span class="sxs-lookup"><span data-stu-id="806e6-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="806e6-147">System ochrony danych udostępnia interfejsem `IKeyManager` który można sprawdzić i zmienić pierścień klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="806e6-148">System Podpisane podane wystąpienie `IDataProtectionProvider` może także udostępnić wystąpienia `IKeyManager` do użycia.</span><span class="sxs-lookup"><span data-stu-id="806e6-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="806e6-149">Alternatywnie można ściągnąć `IKeyManager` bezpośrednio z `IServiceProvider` tak jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="806e6-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="806e6-150">Wszystkie działania, które modyfikuje pierścień klucza (Tworzenie nowego klucza jawnie lub odwołania) spowoduje unieważnienie w pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="806e6-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="806e6-151">Następne wywołanie `Protect` lub `Unprotect` spowoduje, że system ochrony danych odczytać pierścień klucza i ponowne utworzenie pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="806e6-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="806e6-152">Poniższy przykład pokazuje, przy użyciu `IKeyManager` interfejs do przeglądania i modyfikowania pierścień klucz, w tym uchylająca istniejących kluczy i ręcznie generowania klucza.</span><span class="sxs-lookup"><span data-stu-id="806e6-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[Main](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="806e6-153">Magazyn kluczy</span><span class="sxs-lookup"><span data-stu-id="806e6-153">Key storage</span></span>

<span data-ttu-id="806e6-154">System ochrony danych ma heurystycznego, zgodnie z którymi spróbuje automatycznie wywnioskować lokalizacji odpowiedniego magazynu kluczy i szyfrowania w mechanizm rest.</span><span class="sxs-lookup"><span data-stu-id="806e6-154">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="806e6-155">Dotyczy to również konfigurowane przez dewelopera aplikacji.</span><span class="sxs-lookup"><span data-stu-id="806e6-155">This is also configurable by the app developer.</span></span> <span data-ttu-id="806e6-156">Poniższe dokumenty omówiono implementacje pola w tych mechanizmów:</span><span class="sxs-lookup"><span data-stu-id="806e6-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="806e6-157">W polu dostawcy magazynu kluczy</span><span class="sxs-lookup"><span data-stu-id="806e6-157">In-box key storage providers</span></span>](key-storage-providers.md#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="806e6-158">W polu klucza szyfrowania dostawców rest</span><span class="sxs-lookup"><span data-stu-id="806e6-158">In-box key encryption at rest providers</span></span>](key-encryption-at-rest.md#data-protection-implementation-key-encryption-at-rest-providers)
