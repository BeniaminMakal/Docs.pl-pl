---
title: Logikę kontrolera testu w programie ASP.NET Core
author: ardalis
description: Dowiedz się, jak logikę kontrolera testu w programie ASP.NET Core za pomocą Moq i struktury xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 08/18/2018
ms.locfileid: "41754511"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="5ef60-103">Logikę kontrolera testu w programie ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="5ef60-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="5ef60-104">Przez [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="5ef60-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="5ef60-105">Kontrolery są centralnym elementem dowolnej aplikacji platformy ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="5ef60-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="5ef60-106">W efekcie powinien mieć pewność, której działają zgodnie z przeznaczeniem dla swojej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="5ef60-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="5ef60-107">Testy automatyczne udostępnić Ci ten zaufania i umożliwić wykrycie błędów, zanim dotrą produkcji.</span><span class="sxs-lookup"><span data-stu-id="5ef60-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="5ef60-108">Należy unikać umieszczania niepotrzebne obowiązki w kontrolerach i upewnij się, zespół testy tylko na obowiązki kontrolera.</span><span class="sxs-lookup"><span data-stu-id="5ef60-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="5ef60-109">Logiką kontrolera powinny być minimalne i nie koncentrować się na logikę lub infrastruktury potencjalne problemy biznesowe (na przykład dostęp do danych).</span><span class="sxs-lookup"><span data-stu-id="5ef60-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="5ef60-110">Przetestuj logiką kontrolera, nie framework.</span><span class="sxs-lookup"><span data-stu-id="5ef60-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="5ef60-111">Test jak kontroler *zachowuje się* oparte na prawidłowe lub nieprawidłowe dane wejściowe.</span><span class="sxs-lookup"><span data-stu-id="5ef60-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="5ef60-112">Testowanie odpowiedzi kontroler, na podstawie wyniku operacji biznesowych, który wykonuje.</span><span class="sxs-lookup"><span data-stu-id="5ef60-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="5ef60-113">Obowiązki typowe kontrolera:</span><span class="sxs-lookup"><span data-stu-id="5ef60-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="5ef60-114">Sprawdź `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="5ef60-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="5ef60-115">Zwraca odpowiedź na błąd, jeśli `ModelState` jest nieprawidłowy.</span><span class="sxs-lookup"><span data-stu-id="5ef60-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="5ef60-116">Pobieranie jednostki biznesowej z trwałości.</span><span class="sxs-lookup"><span data-stu-id="5ef60-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="5ef60-117">Wykonaj akcję na jednostkach biznesowych.</span><span class="sxs-lookup"><span data-stu-id="5ef60-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="5ef60-118">Zapisz stan trwały jednostkach biznesowych.</span><span class="sxs-lookup"><span data-stu-id="5ef60-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="5ef60-119">Zwraca preferowany `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="5ef60-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="5ef60-120">[Wyświetlanie lub pobieranie przykładowego kodu](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([sposobu pobierania](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="5ef60-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="5ef60-121">Testy jednostkowe z logiką kontrolera</span><span class="sxs-lookup"><span data-stu-id="5ef60-121">Unit tests of controller logic</span></span>

<span data-ttu-id="5ef60-122">[Testy jednostkowe](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) obejmują testowanie w ramach aplikacji w izolacji od jego infrastruktura i zależności.</span><span class="sxs-lookup"><span data-stu-id="5ef60-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="5ef60-123">Gdy logiką kontrolera, tylko zawartość jednej akcji testów jednostkowych jest testowany, nie zachowanie jego zależności lub samej strukturze.</span><span class="sxs-lookup"><span data-stu-id="5ef60-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="5ef60-124">Jako jednostki możesz przetestować akcji kontrolera, upewnij się, że koncentrują się na jego zachowanie.</span><span class="sxs-lookup"><span data-stu-id="5ef60-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="5ef60-125">Kontroler testu jednostkowego pozwala uniknąć elementów, takich jak [filtry](xref:mvc/controllers/filters), [routingu](xref:fundamentals/routing), lub [wiązanie modelu](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="5ef60-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="5ef60-126">Skupienie się na testowanie tylko jedną z rzeczy, testy jednostkowe są zwykle łatwe do zapisania i szybkie uruchamianie.</span><span class="sxs-lookup"><span data-stu-id="5ef60-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="5ef60-127">Dobrze napisane zestaw testów jednostkowych mogą być uruchamiane często bez koszty ogólne.</span><span class="sxs-lookup"><span data-stu-id="5ef60-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="5ef60-128">Jednak testy jednostkowe Nie wykrywaj problemy w interakcji między składnikami, który jest celem [testy integracji](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="5ef60-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="5ef60-129">Jeśli piszesz filtry niestandardowe i tras, wykonaj następujące czynności jednostki przetestuj je oddzielnie, a nie jako część testy na określony kontroler akcji.</span><span class="sxs-lookup"><span data-stu-id="5ef60-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="5ef60-130">[Tworzenie i Uruchamianie testów jednostkowych za pomocą programu Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="5ef60-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="5ef60-131">Aby zademonstrować testy jednostkowe, przejrzyj następujący kontroler.</span><span class="sxs-lookup"><span data-stu-id="5ef60-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="5ef60-132">Jego Wyświetla listę Burza sesji i zezwala na nowe Burza sesje są tworzone z wpisu:</span><span class="sxs-lookup"><span data-stu-id="5ef60-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="5ef60-133">Obserwowanych kontrolera [zasady jawne zależności](http://deviq.com/explicit-dependencies-principle/), oczekiwano wstrzykiwanie zależności, aby udostępnić wystąpienia `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="5ef60-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="5ef60-134">Dzięki temu dość łatwe testowanie za pomocą platformy makiety obiektu, takie jak [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="5ef60-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="5ef60-135">`HTTP GET Index` Metoda nie ma pętli lub rozgałęziania i tylko wywołania jednej metody.</span><span class="sxs-lookup"><span data-stu-id="5ef60-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="5ef60-136">Testować tę aplikację `Index` metody, należy sprawdzić, czy `ViewResult` jest zwracany za pomocą `ViewModel` z repozytorium `List` metody.</span><span class="sxs-lookup"><span data-stu-id="5ef60-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="5ef60-137">`HomeController` `HTTP POST Index` Należy sprawdzić, metoda (jak pokazano powyżej):</span><span class="sxs-lookup"><span data-stu-id="5ef60-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="5ef60-138">Metoda akcji zwraca nieprawidłowe żądanie `ViewResult` odpowiednimi danymi podczas `ModelState.IsValid` jest `false`.</span><span class="sxs-lookup"><span data-stu-id="5ef60-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="5ef60-139">`Add` Wywoływana jest metoda repozytorium i `RedirectToActionResult` jest zwracany za pomocą poprawne argumenty po `ModelState.IsValid` ma wartość true.</span><span class="sxs-lookup"><span data-stu-id="5ef60-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="5ef60-140">Nieprawidłowy stan modelu mogą być testowane przez dodanie błędów za pomocą `AddModelError` pokazany poniżej pierwszego testu.</span><span class="sxs-lookup"><span data-stu-id="5ef60-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="5ef60-141">Pierwsze badanie potwierdza, kiedy `ModelState` nie jest prawidłowa, taka sama `ViewResult` jest zwracana jako dla `GET` żądania.</span><span class="sxs-lookup"><span data-stu-id="5ef60-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="5ef60-142">Pamiętaj, że test nie próbuje przekazać nieprawidłowy model.</span><span class="sxs-lookup"><span data-stu-id="5ef60-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="5ef60-143">To pomoże w takich sytuacjach przydałaby mimo to, ponieważ powiązanie modelu nie jest uruchomiona (chociaż [test integracji](xref:test/integration-tests) użyje wiązania modelu wykonywania).</span><span class="sxs-lookup"><span data-stu-id="5ef60-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="5ef60-144">W tym przypadku nie jest poddawana testom wiązania modelu.</span><span class="sxs-lookup"><span data-stu-id="5ef60-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="5ef60-145">Te testy jednostkowe są tylko testowanie, jak działa kod w metodzie akcji.</span><span class="sxs-lookup"><span data-stu-id="5ef60-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="5ef60-146">Drugi test weryfikuje, że w przypadku `ModelState` jest prawidłowy, nowy `BrainstormSession` jest dodawana (repozytorium), a metoda zwraca `RedirectToActionResult` z oczekiwanych właściwości.</span><span class="sxs-lookup"><span data-stu-id="5ef60-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="5ef60-147">Pozorowane wywołania, które nie są wywoływane są zwykle zignorowane, ale wywoływania `Verifiable` na końcu instalacji wywołanie umożliwia weryfikowana w teście.</span><span class="sxs-lookup"><span data-stu-id="5ef60-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="5ef60-148">Odbywa się przy użyciu wywołania do `mockRepo.Verify`, który zakończy się niepowodzeniem testu, jeśli oczekiwany metoda nie została wywołana.</span><span class="sxs-lookup"><span data-stu-id="5ef60-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="5ef60-149">Biblioteka Moq używane w tym przykładzie ułatwia mieszać mocks weryfikowalny lub "strict" z-weryfikowalny mocks (nazywanych również "luźne" mocks wycinków).</span><span class="sxs-lookup"><span data-stu-id="5ef60-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="5ef60-150">Dowiedz się więcej o [Dostosowywanie zachowania pozorny przy użyciu Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="5ef60-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="5ef60-151">Inny kontroler w aplikacji Wyświetla informacje związane z sesją określonego Diagram burzy.</span><span class="sxs-lookup"><span data-stu-id="5ef60-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="5ef60-152">Zawiera logikę do czynienia z wartościami nieprawidłowy identyfikator:</span><span class="sxs-lookup"><span data-stu-id="5ef60-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="5ef60-153">Akcja kontrolera ma trzy przypadki, aby przetestować, jednej dla każdego `return` instrukcji:</span><span class="sxs-lookup"><span data-stu-id="5ef60-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="5ef60-154">Aplikacja ujawnia funkcjonalność w postaci internetowego interfejsu API (Lista pomysły skojarzony z sesją Diagram burzy a metoda dodawania nowych pomysłów do sesji):</span><span class="sxs-lookup"><span data-stu-id="5ef60-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="5ef60-155">`ForSession` Metoda zwraca listę `IdeaDTO` typów.</span><span class="sxs-lookup"><span data-stu-id="5ef60-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="5ef60-156">Należy unikać cofania jednostek biznesowych domeny bezpośrednio za pomocą wywołań interfejsu API, ponieważ często zawierają więcej danych niż klienta interfejsu API wymaga, a ich niepotrzebnie Połącz modelu domeny wewnętrznej aplikacji przy użyciu interfejsu API, należy udostępnić zewnętrznie.</span><span class="sxs-lookup"><span data-stu-id="5ef60-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="5ef60-157">Mapowanie między domeny jednostek i typy będzie zwracać przewodowo może odbywać się ręcznie (przy użyciu LINQ `Select` jak pokazano poniżej) lub za pomocą biblioteki, takich jak [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="5ef60-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="5ef60-158">Testowanie jednostkowe dla `Create` i `ForSession` metody interfejsu API:</span><span class="sxs-lookup"><span data-stu-id="5ef60-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="5ef60-159">Jak wspomniano wcześniej, aby sprawdzić zachowanie metody podczas `ModelState` jest nieprawidłowy, dodać błąd modelu do kontrolera jako część testu.</span><span class="sxs-lookup"><span data-stu-id="5ef60-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="5ef60-160">Nie należy próbować testów sprawdzania poprawności lub modelu wiązania modelu do testów jednostkowych — po prostu testowanie zachowania metodzie akcji, gdy do czynienia z określonym `ModelState` wartość.</span><span class="sxs-lookup"><span data-stu-id="5ef60-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="5ef60-161">Drugi test jest zależny od repozytorium, zwracając wartość null, aby zasymulować repozytorium jest skonfigurowany do zwrócenia wartości null.</span><span class="sxs-lookup"><span data-stu-id="5ef60-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="5ef60-162">Nie ma potrzeby tworzenia bazy danych testowych (w pamięci lub w inny sposób) i utworzyć zapytanie, które zwróci wynik — może to nastąpić w pojedynczej instrukcji jak pokazano.</span><span class="sxs-lookup"><span data-stu-id="5ef60-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="5ef60-163">Ostatni test sprawdza, czy z repozytorium `Update` metoda jest wywoływana.</span><span class="sxs-lookup"><span data-stu-id="5ef60-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="5ef60-164">Ile My mieliśmy wcześniej, pozorny jest wywoływana z `Verifiable` i następnie pozorowane z repozytorium `Verify` metoda jest wywoływana, aby upewnić się, możliwe do zweryfikowania metoda została wykonana.</span><span class="sxs-lookup"><span data-stu-id="5ef60-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="5ef60-165">Nie jest obowiązkiem testu jednostki, upewnij się, że `Update` metody zapisane dane; można to zrobić za pomocą wiąże się test integracji.</span><span class="sxs-lookup"><span data-stu-id="5ef60-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="5ef60-166">Dodatkowe zasoby</span><span class="sxs-lookup"><span data-stu-id="5ef60-166">Additional resources</span></span>

* <xref:test/integration-tests>
