---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Zapobieganie Cross-Site (CSRF) Fałszerstwie żądania w składniku ASP.NET Web API | Dokumentacja firmy Microsoft
author: MikeWasson
description: Opisuje żądania międzywitrynowego ataku sfałszowaniem (CSRF) oraz wdrożenie środków anti-CSRF w interfejsu API sieci Web platformy ASP.NET.
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/12/2012
ms.topic: article
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 1cd03f3b396cc2ece1d8dbe6820f6277c02d8e62
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 11/10/2017
ms.locfileid: "26566750"
---
<a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-web-api"></a><span data-ttu-id="b5e14-103">Zapobieganie Cross-Site (CSRF) Fałszerstwie żądania w składniku ASP.NET Web API</span><span class="sxs-lookup"><span data-stu-id="b5e14-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET Web API</span></span>
====================
<span data-ttu-id="b5e14-104">przez [Wasson Jan](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="b5e14-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="b5e14-105">Sfałszowaniem żądania między witrynami (CSRF) jest atak, gdzie niebezpiecznej witryny wysyła żądanie do narażone lokacji, w którym użytkownik jest aktualnie zalogowany</span><span class="sxs-lookup"><span data-stu-id="b5e14-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="b5e14-106">Oto przykład ataku CSRF:</span><span class="sxs-lookup"><span data-stu-id="b5e14-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="b5e14-107">Uwierzytelnianie przy użyciu formularzy logowania użytkownika do www.example.com.</span><span class="sxs-lookup"><span data-stu-id="b5e14-107">A user logs into www.example.com, using forms authentication.</span></span>
2. <span data-ttu-id="b5e14-108">Serwer uwierzytelnia użytkownika.</span><span class="sxs-lookup"><span data-stu-id="b5e14-108">The server authenticates the user.</span></span> <span data-ttu-id="b5e14-109">Odpowiedź z serwera zawiera pliku cookie uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="b5e14-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="b5e14-110">Bez rejestrowania, użytkownik odwiedzi złośliwą witrynę sieci web.</span><span class="sxs-lookup"><span data-stu-id="b5e14-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="b5e14-111">Ta witryna złośliwego zawiera poniższy formularz HTML:</span><span class="sxs-lookup"><span data-stu-id="b5e14-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="b5e14-112">Należy zauważyć, że akcja formularza zapisuje do lokacji narażony, nie niebezpiecznej witryny.</span><span class="sxs-lookup"><span data-stu-id="b5e14-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="b5e14-113">Jest to część CSRF "cross-site".</span><span class="sxs-lookup"><span data-stu-id="b5e14-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="b5e14-114">Użytkownik klika przycisk Prześlij.</span><span class="sxs-lookup"><span data-stu-id="b5e14-114">The user clicks the submit button.</span></span> <span data-ttu-id="b5e14-115">Przeglądarka zawiera pliku cookie uwierzytelniania z żądaniem.</span><span class="sxs-lookup"><span data-stu-id="b5e14-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="b5e14-116">Żądanie działa na serwerze z kontekstem uwierzytelniania użytkownika i mogą wykonywać wszystkie uwierzytelniony użytkownik może wykonywać.</span><span class="sxs-lookup"><span data-stu-id="b5e14-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="b5e14-117">Mimo że w tym przykładzie wymaga od użytkownika kliknij przycisk formularz, strony złośliwych może równie łatwo uruchomić skrypt, który automatycznie wyśle formularz.</span><span class="sxs-lookup"><span data-stu-id="b5e14-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="b5e14-118">Ponadto przy użyciu protokołu SSL nie atak CSRF, ponieważ złośliwa witryna można wysyłać żądania "https://".</span><span class="sxs-lookup"><span data-stu-id="b5e14-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="b5e14-119">Zazwyczaj CSRF ataki są możliwe przed witryn sieci web, które używają plików cookie do uwierzytelniania, ponieważ przeglądarki wysyłać wszystkich odpowiednich plików cookie do docelowej witryny sieci web.</span><span class="sxs-lookup"><span data-stu-id="b5e14-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="b5e14-120">Jednak ataków CSRF nie są ograniczone do wykorzystania plików cookie.</span><span class="sxs-lookup"><span data-stu-id="b5e14-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="b5e14-121">Na przykład uwierzytelnianie podstawowe i szyfrowane również są zagrożone.</span><span class="sxs-lookup"><span data-stu-id="b5e14-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="b5e14-122">Po zalogowaniu się użytkownika za pomocą uwierzytelnianie podstawowe lub szyfrowane.</span><span class="sxs-lookup"><span data-stu-id="b5e14-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="b5e14-123">przeglądarka automatycznie wysyła poświadczenia zakończenia sesji.</span><span class="sxs-lookup"><span data-stu-id="b5e14-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="b5e14-124">Tokenów zabezpieczających przed sfałszowaniem</span><span class="sxs-lookup"><span data-stu-id="b5e14-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="b5e14-125">Aby zapobiec atakom CSRF, ASP.NET MVC korzysta z tokenów zabezpieczających przed sfałszowaniem, nazywany również *żądania weryfikacji tokenów*.</span><span class="sxs-lookup"><span data-stu-id="b5e14-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="b5e14-126">Strona HTML, która zawiera formularz żądania klienta.</span><span class="sxs-lookup"><span data-stu-id="b5e14-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="b5e14-127">Serwer zawiera dwa tokeny w odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="b5e14-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="b5e14-128">Jeden token jest wysyłany jako plik cookie.</span><span class="sxs-lookup"><span data-stu-id="b5e14-128">One token is sent as a cookie.</span></span> <span data-ttu-id="b5e14-129">Druga znajduje się w polu ukrytym.</span><span class="sxs-lookup"><span data-stu-id="b5e14-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="b5e14-130">Tokeny są generowane losowo tak, aby Atakujący dokonuje nie można odgadnąć wartości.</span><span class="sxs-lookup"><span data-stu-id="b5e14-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="b5e14-131">Gdy klient przesyła formularz, przesyła oba tokeny do serwera.</span><span class="sxs-lookup"><span data-stu-id="b5e14-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="b5e14-132">Klient wysyła ten token pliku cookie jako plik cookie, a następnie wysyła tokenu formularza wewnątrz dane formularza.</span><span class="sxs-lookup"><span data-stu-id="b5e14-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="b5e14-133">(Klient przeglądarki automatycznie dzieje się tak, gdy użytkownik przesyła formularz.)</span><span class="sxs-lookup"><span data-stu-id="b5e14-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="b5e14-134">Jeśli żądanie nie zawiera oba tokeny, serwer nie zezwala na żądanie.</span><span class="sxs-lookup"><span data-stu-id="b5e14-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="b5e14-135">Oto przykład formularza HTML przy użyciu tokenu w ukrytym:</span><span class="sxs-lookup"><span data-stu-id="b5e14-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="b5e14-136">Tokenów zabezpieczających przed sfałszowaniem działać, ponieważ złośliwy strony nie może odczytać tokenów użytkownika, z powodu zasad tego samego źródła.</span><span class="sxs-lookup"><span data-stu-id="b5e14-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="b5e14-137">([Zasady samego pochodzenia](http://www.w3.org/Security/wiki/Same_Origin_Policy) dokumentów hostowanej w dwóch różnych witrynach dostęp do jego zawartości.</span><span class="sxs-lookup"><span data-stu-id="b5e14-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="b5e14-138">Dlatego w przypadku poprzedniego przykładu, strony złośliwych mogą wysyłać żądania do example.com, ale nie można odczytać odpowiedzi).</span><span class="sxs-lookup"><span data-stu-id="b5e14-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="b5e14-139">Aby zapobiegać atakom CSRF, użyj tokenów zabezpieczających przed sfałszowaniem z dowolnego protokołu uwierzytelniania, których przeglądarka dyskretnie wysyła poświadczenia po zalogowaniu się użytkownika.</span><span class="sxs-lookup"><span data-stu-id="b5e14-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="b5e14-140">To zawiera protokoły uwierzytelniania opartego na pliku cookie, takich jak uwierzytelnianie formularzy, a także protokołów, takich jak uwierzytelnianie podstawowe i szyfrowane.</span><span class="sxs-lookup"><span data-stu-id="b5e14-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="b5e14-141">Dla żadnych metod nonsafe (POST, PUT, DELETE), należy włączyć tokenów zabezpieczających przed sfałszowaniem.</span><span class="sxs-lookup"><span data-stu-id="b5e14-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="b5e14-142">Ponadto upewnij się, że bezpieczne metody (GET, HEAD) nie mają żadnych efektów ubocznych.</span><span class="sxs-lookup"><span data-stu-id="b5e14-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="b5e14-143">Ponadto jeśli zostanie włączona obsługa między domenami, takie jak CORS lub JSONP, następnie nawet bezpiecznych metod, takich jak GET są potencjalnie narażone na ataki CSRF, co umożliwi jej uzyskanie odczytać potencjalnie poufnych danych.</span><span class="sxs-lookup"><span data-stu-id="b5e14-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="b5e14-144">Tokenów zabezpieczających przed sfałszowaniem na platformie ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="b5e14-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="b5e14-145">Aby dodać tokenów zabezpieczających przed sfałszowaniem do strony Razor, użyj **HtmlHelper.AntiForgeryToken** metody pomocniczej:</span><span class="sxs-lookup"><span data-stu-id="b5e14-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="b5e14-146">Ta metoda dodaje ukryte pole formularza i określa również token pliku cookie.</span><span class="sxs-lookup"><span data-stu-id="b5e14-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="b5e14-147">Anti-CSRF i AJAX</span><span class="sxs-lookup"><span data-stu-id="b5e14-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="b5e14-148">Tokenu formularza może to stanowić problem dla żądania AJAX, ponieważ żądanie AJAX może wysyłać dane JSON, a nie dane formularza HTML.</span><span class="sxs-lookup"><span data-stu-id="b5e14-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="b5e14-149">Rozwiązanie polega na wysyłanie tokenów w niestandardowy nagłówek HTTP.</span><span class="sxs-lookup"><span data-stu-id="b5e14-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="b5e14-150">Poniższy kod używa składni Razor do generowania tokenów, a następnie dodaje tokenów na żądanie AJAX.</span><span class="sxs-lookup"><span data-stu-id="b5e14-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="b5e14-151">Tokeny są generowane na serwerze przez wywołanie metody **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="b5e14-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="b5e14-152">Podczas przetwarzania żądania, Wyodrębnij tokenów w nagłówku żądania.</span><span class="sxs-lookup"><span data-stu-id="b5e14-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="b5e14-153">Następnie wywołaj **AntiForgery.Validate** metody do weryfikacji tokenów.</span><span class="sxs-lookup"><span data-stu-id="b5e14-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="b5e14-154">**Weryfikacji** metoda zgłasza wyjątek, jeśli tokenów nie są prawidłowe.</span><span class="sxs-lookup"><span data-stu-id="b5e14-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
